# project 5： a）SM2 的软件实现优化。 b）20250713-温-sm2-public.pdf 中提到的关于签名算法的误用 分别基于做poc验证，给出推导文档以及验证代码。 c）伪造中本聪的数字签名。
SM2是中国国家密码管理局发布的一种基于椭圆曲线密码（ECC）的公钥密码算法标准，采用256位素数域上的椭圆曲线，安全性相当于3072位RSA。
# 椭圆曲线基础：
### 基本方程
- **一般形式**:  
  `y² = x³ + ax + b`（定义在有限域上，如素数域 𝔽ₚ）
- **约束条件**:  
  `4a³ + 27b² ≠ 0`（确保曲线无奇点，光滑性）
- **SM2的曲线参数**:
  - 素数 `p`、系数 `a`、`b`、基点 `G`、阶 `n` 等均由国家密码管理局标准化

### 有限域上的运算
- 所有坐标和运算均在有限域 𝔽ₚ 上进行（模 `p` 运算）

## 椭圆曲线上的群运算

### 点加法（P + Q）
1. 若 `P ≠ Q`: 连接P和Q的直线与曲线交于第三点-R，取对称点R
2. 若 `P = Q`（倍点运算）: 取曲线在P点的切线的交点
3. **公式**（素数域 𝔽ₚ）:
   - 斜率 λ = 
     ```
     (y_Q - y_P)/(x_Q - x_P) mod p    if P ≠ Q
     (3x_P² + a)/(2y_P) mod p         if P = Q
     ```
   - 结果点 R = (x_R, y_R):
     ```
     x_R = λ² - x_P - x_Q mod p
     y_R = λ(x_P - x_R) - y_P mod p
     ```

### 单位元和逆元
- **单位元**: 无穷远点 𝒪（满足 P + 𝒪 = P）
- **逆元**: 点 (x, y) 的逆元为 (x, -y mod p)

## 椭圆曲线离散对数问题（ECDLP）
- **问题描述**: 已知基点 G 和点 P = k·G，求整数 k（私钥）
- **SM2的安全性基础**: ECDLP在经典计算机上无有效解法（量子计算机除外）
- **对比**: 256位ECC密钥的安全性 ≈ 3072位RSA

## 密钥对生成
- **私钥 d**: 随机数 d ∈ [1, n-1]
- **公钥 P**: 通过标量乘法计算 P = d·G

具体代码见SM2.py


# SM2 算法优化内容

## 1. 基础运算优化

### 模逆计算优化
- 使用扩展欧几里得算法实现 `mod_inverse` 函数
- 替代原始的 `pow(dx, p-2, p)` 模逆计算方式
- 优势：在某些场景下计算效率更高且适用性更广

### 点乘算法优化
- 重构 `point_mul_optimized` 函数
- 采用更稳定的二进制双加算法实现标量乘法
- 确保计算正确性的同时提升效率
- 明确处理标量为 0 的边界情况

## 2. 公钥压缩与解压缩

### 新增`compress_public_key` 函数
- 将公钥从 64 字节（x 坐标 + y 坐标）压缩为 33 字节
- 格式：1 字节奇偶标志 + 32 字节 x 坐标
- 优势：大幅减少存储空间和传输带宽

### 新增`decompress_public_key` 函数
- 通过压缩公钥的 33 字节数据恢复完整公钥坐标
- 利用椭圆曲线方程特性：`y² ≡ x³ + ax + b (mod p)`
- 利用 SM2 曲线参数特性：`p ≡ 3 mod 4`
- 优势：快速恢复完整公钥坐标

## 3. 签名验证优化

### 批量验证支持
- 引入 `batch_verify` 函数
- 结合 `ThreadPoolExecutor` 实现多签名的并行验证
- 优势：显著提升多签名场景下的验证效率

### 验证流程拆分
- 将单签名验证逻辑拆分为 `verify_single` 函数
- 优势：代码结构更清晰
- 为批量验证提供基础支持

## 4. 加密解密流程优化

### 密文长度优化
- 加密函数 `encrypt` 采用压缩后的 C1（33 字节）
- 替代原始的 64 字节未压缩 C1
- 密文总长度变化：
  - 原始：64+32+len(C2)
  - 优化后：33+32+len(C2)

### 安全性增强
- 解密函数 `decrypt` 中新增对 C3 的哈希验证
- 验证条件：`sha256(hash_input).digest() != C3` 时抛出异常
- 优势：更符合 SM2 标准流程

## 5. 签名生成优化

### 签名有效性校验
- 签名函数 `sign` 中新增循环校验逻辑
- 确保生成的 r 和 s 满足：
  - `r ≠ 0`
  - `r + k ≠ n`
  - `s ≠ 0`
- 优势：避免生成无效签名

### 参数规范化处理
- 明确处理 s 的负数情况
- 当 `s < 0` 时加 n 调整为正数
- 优势：确保签名参数的规范性


